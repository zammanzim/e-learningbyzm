<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Nilai PSASI</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-clients.js"></script>
    <script src="js/basicfeat.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/visitor.js"></script>
    <link rel="stylesheet" href="css/styleasli.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        /* Card Dashboard Personal */
        .carddashboard {
            gap: 16px;
            padding: 20px;
            border-radius: 18px;
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 191, 255, 0.4);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.25);
            width: 100%;
            margin-bottom: 30px;
            text-align: left;
            position: relative;
        }

        #pp {
            width: 85px;
            height: 85px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #00eaff;
            box-shadow: 0 0 10px #00eaff;
            float: left;
            margin-right: 20px;
        }

        .userInfo {
            text-align: left;
            height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #rataNum {
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            display: inline-block;
            margin-top: 10px;
            font-size: 24px;
        }

        /* Tabel Personal */
        .personal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .personal-table td,
        .personal-table th {
            padding: 8px;
            border: none;
            text-align: center;
        }

        .personal-table th {
            background: rgba(0, 234, 255, 0.1);
            color: #00eaff;
        }

        /* CRYSTAL BUTTONS */
        .crystal-btn {
            all: unset;
            padding: 12px 22px;
            border-radius: 14px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            display: inline-block;
            text-align: center;
            color: white;
            backdrop-filter: blur(6px);
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.35);
            transition: 0.25s ease;
            margin: 0 10px;
        }

        .crystal-red {
            background: linear-gradient(135deg, rgba(255, 85, 85, 0.65), rgba(255, 35, 35, 0.45));
            border-color: rgba(255, 150, 150, 0.5);
        }

        .crystal-green {
            background: linear-gradient(135deg, rgba(80, 255, 150, 0.6), rgba(20, 200, 100, 0.4));
            border-color: rgba(120, 255, 170, 0.5);
        }

        .crystal-btn:hover {
            transform: scale(1.05);
        }

        /* PODIUM */
        .podium-container-5 {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            margin-top: 50px;
            flex-wrap: wrap;
        }

        .podium {
            width: 120px;
            border: 2px solid #b6ffda;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            text-align: center;
            position: relative;
            padding-top: 40px;
            margin-bottom: 20px;
        }

        .pp-top {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 50%;
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            border: 2px solid white;
        }

        .podium.p1 {
            height: 200px;
            background: rgba(255, 215, 0, 0.2);
            border-color: gold;
        }

        .podium.p2 {
            height: 170px;
            background: rgba(255, 215, 210, 0.2);
        }

        .podium.p3 {
            height: 150px;
        }

        .podium.pd {
            height: 140px;
        }

        /* Rank 4-10 */

        /* Select Mapel di Kanan */
        .mapel-select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid #00eaff;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-left">
            <div class="hamburger" id="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>

            <div id="visitorTrigger" class="visitor-trigger">
                <i class="fa-solid fa-eye"></i>
                <span id="headerVisitorCount">0</span>
            </div>
        </div>

        <div class="profile-box" id="profileTrigger">
            <span id="headerName">Hai, ...</span>
            <img id="headerPP" class="header-pp">
            <i class="fa-solid fa-caret-down"></i>
        </div>

        <div class="profile-dropdown" id="profileDropdown">
            <ul>
                <li onclick="goDashboard()"><i class="fa-solid fa-table-columns"></i> Dashboard</li>
                <li onclick="goProfile()"><i class="fa-solid fa-user"></i> Edit Profile</li>
                <li onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</li>
            </ul>
        </div>
    </header>

    <div id="visitorOverlay" class="visitor-overlay">
        <div class="visitor-popup">

            <div class="popup-header">
                <h3>Visitors</h3>
                <span id="closeVisitorPopup" class="close-popup">&times;</span>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h4><i class="fa-solid fa-eye"></i> Today Visitor</h4>
                    <p id="popupToday">0</p>
                </div>
                <div class="stat-card">
                    <h4><i class="fa-solid fa-users"></i> Total Visitor</h4>
                    <p id="popupTotal">0</p>
                </div>
            </div>

            <div class="list-section">
                <h4 class="list-title">List of accounts that visited today</h4>
                <div id="visitorList" class="visitor-list-container"></div>
            </div>

            <div class="admin-actions" style="margin-top: 20px;">
                <button id="resetVisitorBtn" class="btn-reset-text">
                    <i class="fa-solid fa-rotate-right"></i> Reset Today (Admin)
                </button>
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar"></div>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <div class="main-content">
        <div class="left-section">
            <h1 style="color: #00eaff;"><i class="fa-solid fa-clipboard-check"></i> Nilai PSAS</h1>
            <p style="opacity: 0.8; margin-bottom: 20px;">PSASI 25-26 ‚Ä¢ X-RPL 2</p>

            <div class="course-card">
                <img id="pp" src="profpicture.png">
                <div class="userInfo">
                    <p id="uname" style="margin:0; font-weight:bold;">@username</p>
                    <h3 id="name" style="margin:0; opacity:0.8;">Loading...</h3>
                </div>

                <h3>Daftar Nilai Kamu:</h3>
                <table class="personal-table" id="personalTable">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Mapel</th>
                            <th>Nilai</th>
                            <th>KKM?</th>
                        </tr>
                    </thead>
                    <tbody id="personalTableBody">
                    </tbody>
                </table>

                <div style="text-align:center; margin-top:20px;">
                    <h3 style="margin-bottom:5px;">Rata-Rata Kamu:</h3>
                    <h2 id="rataNum">-</h2>
                    <p id="ucapanText" style="margin-top:10px; font-style:italic;"></p>
                    <p id="peringkat" style="margin-top:10px; font-weight:bold; color:#00eaff;"></p>
                </div>
            </div>

            <div class="course-card">
                <h1 style="color: #00eaff;">Top 15 Leaderboard</h1>
                <p style="opacity: 0.8; margin-bottom: 20px;">Ranking Berdasarkan Rata-Rata Nilai PSAS</p>

                <div class="podium-container-5" id="podiumTop3">
                </div>
                <hr style="margin: 30px 0; border-color:rgba(0,191,255,0.4);">
                <div class="podium-container-5" id="podiumRest">
                </div>
            </div>
        </div>

        <div class="right-section course-card">
            <h2 style="color: #00eaff;">Daftar Nilai Kelas</h2>
            <p style="opacity:0.7; margin-bottom:15px;">Pilih Mapel untuk melihat nilai semua siswa.</p>

            <select id="mapelSelector" class="mapel-select" onchange="renderClassTable()">
                <option value="pabp">PABP</option>
                <option value="pp">PP</option>
                <option value="bindo">B. Indonesia</option>
                <option value="bing">B. Inggris</option>
                <option value="mtk">Matematika</option>
                <option value="sejarah">Sejarah</option>
                <option value="bjepang">B. Jepang</option>
                <option value="bsunda">B. Sunda</option>
                <option value="senibudaya">Seni Budaya</option>
                <option value="informatika">Informatika</option>
                <option value="pjok">PJOK</option>
                <option value="proipas">Proipas</option>
                <option value="dasprog1">DASPROGRPL 1</option>
                <option value="dasprog2">DASPROGRPL 2</option>
                <option value="dasprog3">DASPROGRPL 3</option>
            </select>

            <table class="personal-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nama</th>
                        <th>Nilai</th>
                    </tr>
                </thead>
                <tbody id="classTableBody">
                </tbody>
            </table>
        </div>
    </div>
    <script>
        // Config Mapel
        const MAPEL_CONFIG = {
            'pabp': 'PABP',
            'pp': 'PP',
            'bindo': 'B. Indonesia',
            'bing': 'B. Inggris',
            'mtk': 'Matematika',
            'sejarah': 'Sejarah',
            'bjepang': 'B. Jepang',
            'bsunda': 'B. Sunda',
            'senibudaya': 'Seni Budaya',
            'informatika': 'Informatika',
            'pjok': 'PJOK',
            'proipas': 'Proipas',
            'dasprog1': 'DASPROGRPL 1',
            'dasprog2': 'DASPROGRPL 2',
            'dasprog3': 'DASPROGRPL 3'
        };

        const KKM = 75;
        let globalData = [];

        const localUser = JSON.parse(localStorage.getItem("user"));
        const myIdentifier = localUser ? (localUser.nickname || localUser.username) : null;

        document.addEventListener("DOMContentLoaded", async function () {
            if (typeof SubjectApp !== 'undefined') SubjectApp.init("nilai", "Nilai PSAS");
            
            updateProfileUI(localUser);
            await loadData();
        });

        function updateProfileUI(user) {
            const display = user.nickname;
            if (document.getElementById('name')) document.getElementById('name').innerText = user.full_name || display;
            if (document.getElementById('uname')) document.getElementById('uname').innerText = `@${user.username}`;

            const ppUrl = user.avatar_url || 'profpicture.png';
            if (document.getElementById('pp')) document.getElementById('pp').src = ppUrl;
        }

        // ==========================================
        // CUSTOM COLOR GRADING (0 - 100)
        // ==========================================
        function getDynamicColor(nilai) {
            const n = parseFloat(nilai);
            if (isNaN(n)) return "#888"; // Abu-abu kalau kosong

            // 90 - 100: Cyan Banget (Neon)
            if (n >= 90) return "#00eaff";

            // 80 - 90: Cyan Kurang Cerah (Agak redup/Teal)
            if (n >= 80) return "#00cec9";

            // 70 - 80: Hijau Cyan (Turquoise)
            if (n >= 70) return "#1abc9c";

            // 60 - 70: Hijau (Green)
            if (n >= 60) return "#2ecc71";

            // 50 - 60: Kuning Hijau (Lime)
            if (n >= 50) return "#badc58";

            // 40 - 50: Kuning (Yellow)
            if (n >= 40) return "#f1c40f";

            // 30 - 40: Merah Orange (Carrot)
            if (n >= 30) return "#e67e22";

            // 20 - 30: Merah Biasa
            if (n >= 20) return "#e74c3c";

            // 0 - 20: Merah Banget (Maroon/Dark Red)
            return "#c0392b";
        }

        async function loadData() {
            const { data, error } = await supabase
                .from('nilai_psasi')
                .select('*')
                .eq('class_id', localUser.class_id);

            if (error || !data) return;

            globalData = data.map(siswa => {
                let total = 0, count = 0;
                for (let key in MAPEL_CONFIG) {
                    let val = parseFloat(siswa[key]);
                    if (!isNaN(val)) { total += val; count++; }
                }
                const avg = count > 0 ? (total / count).toFixed(2) : "0.00";
                return { ...siswa, average: parseFloat(avg) };
            });

            globalData.sort((a, b) => b.average - a.average);

            renderPersonal();
            renderPodium();
            renderClassTable();
        }

        function renderPersonal() {
            if (!myIdentifier) return;

            const myIndex = globalData.findIndex(s =>
                s.nama_siswa.toLowerCase() === myIdentifier.toLowerCase()
            );
            const myData = globalData[myIndex];

            if (!myData) {
                document.getElementById('rataNum').innerText = "-";
                return;
            }

            // 1. RATA-RATA: UBAH WARNA TEXT (Bukan Background)
            const rataEl = document.getElementById('rataNum');
            rataEl.innerText = myData.average.toFixed(2);

            const fontColor = getDynamicColor(myData.average);

            // Reset background jadi transparan
            rataEl.style.background = "rgba(255,255,255,0.05)";
            rataEl.style.color = fontColor; // <--- INI YG DIRUBAH
            rataEl.style.textShadow = `0 0 15px ${fontColor}`; // Efek NEON GLOW
            rataEl.style.boxShadow = "none"; // Hapus kotak glow

            // Logic Ucapan
            const ucapan = document.getElementById('ucapanText');
            // Warna ucapan ngikutin warna nilai juga biar matching
            ucapan.style.color = fontColor;
            ucapan.style.textShadow = "0 0 5px rgba(0,0,0,0.5)";

            if (myData.average >= 80) ucapan.innerText = "dinginn ah di puncakü•∂";
            else if (myData.average >= 75) ucapan.innerText = "pass KKM eyyy, hore";
            else if (myData.average >= 70) ucapan.innerText = "yah tipis";
            else if (myData.average >= 60) ucapan.innerText = "lumayann lahh sakie ma";
            else if (myData.average >= 50) ucapan.innerText = "gaoaoa, trs semangat";
            else ucapan.innerText = "gapapa dibawah 50, yang penting jujur.";

            // Ranking
            const rank = myIndex + 1;
            document.getElementById('peringkat').innerHTML = `Peringkat <span style="color:${fontColor}; font-size:1.3em; font-weight:bold;">#${rank}</span>`;

            // 2. TABEL PERSONAL: UBAH WARNA TEXT
            const tbody = document.getElementById('personalTableBody');
            tbody.innerHTML = "";
            let no = 1;

            for (let key in MAPEL_CONFIG) {
                const val = parseFloat(myData[key]);
                const isAda = !isNaN(val);
                const displayVal = isAda ? val.toFixed(2) : "-";

                // Generate warna TEXT
                const textColor = isAda ? getDynamicColor(val) : "#fff";

                const tr = `<tr>
                <td>${no++}</td>
                <td style="text-align:left;">${MAPEL_CONFIG[key]}</td>
                <td style="font-weight:bold; font-size:16px; color: ${textColor}; text-shadow: 0 0 8px ${textColor};">
                    ${displayVal}
                </td>
                <td>${isAda ? (val >= KKM ? '‚úÖ' : '‚ùå') : '-'}</td>
            </tr>`;
                tbody.innerHTML += tr;
            }
        }

        function renderPodium() {
            const top3 = document.getElementById('podiumTop3');
            const rest = document.getElementById('podiumRest');
            if (top3) top3.innerHTML = "";
            if (rest) rest.innerHTML = "";

            const createPodiumHTML = (siswa, rank, cls) => {
                const color = getDynamicColor(siswa.average);
                return `
            <div class="podium ${cls}">
                <img src="studentsprofile/${siswa.nama_siswa}.jpg" class="pp-top" onerror="this.src='profpicture.png'">
                <div style="font-weight:bold; margin-top:5px; font-size:13px;">${siswa.nama_siswa}</div>
                
                <div style="font-size:14px; margin-top:2px; color:${color}; font-weight:bold; text-shadow: 0 0 5px ${color};">
                    ${siswa.average.toFixed(2)}
                </div>
                
                <div style="font-size:20px; font-weight:900; opacity:0.3; position:absolute; bottom:5px; left:50%; transform:translateX(-50%);">${rank}</div>
            </div>
        `};

            if (globalData[1]) top3.innerHTML += createPodiumHTML(globalData[1], 2, 'p2');
            if (globalData[0]) top3.innerHTML += createPodiumHTML(globalData[0], 1, 'p1');
            if (globalData[2]) top3.innerHTML += createPodiumHTML(globalData[2], 3, 'p3');

            for (let i = 3; i < 15; i++) {
                if (globalData[i]) rest.innerHTML += createPodiumHTML(globalData[i], i + 1, 'pd');
            }
        }

        function renderClassTable() {
            const mapelKey = document.getElementById('mapelSelector').value;
            const tbody = document.getElementById('classTableBody');
            tbody.innerHTML = '';

            const sortedList = [...globalData].sort((a, b) => {
                const valA = parseFloat(a[mapelKey]) || 0;
                const valB = parseFloat(b[mapelKey]) || 0;
                return valB - valA;
            });

            sortedList.forEach((siswa, i) => {
                const val = parseFloat(siswa[mapelKey]);
                const displayVal = !isNaN(val) ? val.toFixed(2) : "-";
                const color = !isNaN(val) ? getDynamicColor(val) : "#fff";

                const tr = document.createElement('tr');
                if (myIdentifier && siswa.nama_siswa.toLowerCase() === myIdentifier.toLowerCase()) {
                    tr.style.background = 'rgba(0, 234, 255, 0.15)';
                    tr.style.fontWeight = 'bold';
                    tr.style.borderLeft = '3px solid #00eaff';
                }

                // Kolom Nilai pakai warna text
                tr.innerHTML = `
                <td>${i + 1}</td>
                <td>${siswa.nama_siswa}</td>
                <td style="font-weight:bold; color:${color}; text-shadow:0 0 5px ${color};">
                    ${displayVal}
                </td>
            `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>

</html>