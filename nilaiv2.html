<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Nilai PSASI V2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-clients.js"></script>
    <script src="js/basicfeat.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/subject-manager.js"></script>

    <link rel="stylesheet" href="css/styleasli.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        /* Card Dashboard Personal */
        .carddashboard {
            gap: 16px;
            padding: 20px;
            border-radius: 18px;
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 191, 255, 0.4);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.25);
            width: 100%;
            margin-bottom: 30px;
            text-align: left;
            position: relative;
        }

        #pp {
            width: 85px;
            height: 85px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #00eaff;
            box-shadow: 0 0 10px #00eaff;
            float: left;
            margin-right: 20px;
        }

        .userInfo {
            text-align: left;
            height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #rataNum {
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            display: inline-block;
            margin-top: 10px;
            font-size: 24px;
        }

        /* Tabel Personal */
        .personal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .personal-table td,
        .personal-table th {
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .personal-table th {
            background: rgba(0, 234, 255, 0.1);
            color: #00eaff;
        }

        /* CRYSTAL BUTTONS */
        .crystal-btn {
            all: unset;
            padding: 12px 22px;
            border-radius: 14px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            display: inline-block;
            text-align: center;
            color: white;
            backdrop-filter: blur(6px);
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.35);
            transition: 0.25s ease;
            margin: 0 10px;
        }

        .crystal-red {
            background: linear-gradient(135deg, rgba(255, 85, 85, 0.65), rgba(255, 35, 35, 0.45));
            border-color: rgba(255, 150, 150, 0.5);
        }

        .crystal-green {
            background: linear-gradient(135deg, rgba(80, 255, 150, 0.6), rgba(20, 200, 100, 0.4));
            border-color: rgba(120, 255, 170, 0.5);
        }

        .crystal-btn:hover {
            transform: scale(1.05);
        }

        /* PODIUM */
        .podium-container-5 {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            margin-top: 50px;
            flex-wrap: wrap;
        }

        .podium {
            width: 90px;
            border: 2px solid #b6ffda;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            text-align: center;
            position: relative;
            padding-top: 40px;
            margin-bottom: 20px;
        }

        .pp-top {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 50%;
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            border: 2px solid white;
        }

        .podium.p1 {
            height: 180px;
            background: rgba(255, 215, 0, 0.2);
            border-color: gold;
        }

        .podium.p2 {
            height: 150px;
        }

        .podium.p3 {
            height: 130px;
        }

        .podium.pd {
            height: 120px;
        }

        /* Rank 4-10 */

        /* Select Mapel di Kanan */
        .mapel-select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid #00eaff;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-left">
            <div class="hamburger" id="hamburger" onclick="toggleMenu()"><span></span><span></span><span></span></div>
            <div id="visitorTrigger" class="visitor-trigger"><i class="fa-solid fa-eye"></i> <span
                    id="headerVisitorCount">0</span></div>
        </div>
        <div class="profile-box" id="profileTrigger">
            <span id="headerName">Hai, ...</span>
            <img id="headerPP" class="header-pp">
            <i class="fa-solid fa-caret-down"></i>
        </div>
        <div class="profile-dropdown" id="profileDropdown">
            <ul>
                <li onclick="goDashboard()"><i class="fa-solid fa-table-columns"></i> Dashboard</li>
                <li onclick="goProfile()"><i class="fa-solid fa-user"></i> Edit Profile</li>
                <li onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</li>
            </ul>
        </div>
    </header>

    <div class="sidebar" id="sidebar">
        <h3>Main Menu</h3>
        <ul>
            <li><a href="homev2.html"><i class="fa-solid fa-house"></i> Home</a></li>
            <li><a href="announcements.html"><i class="fa-solid fa-bullhorn"></i> Announcement</a></li>
            <li class="nav-locked"><a href="dashboard.html" class="nav-locked"><i
                        class="fa-solid fa-table-columns"></i>Dashboard</a></li>
            <li class="nav-locked"><a href="profile.html" class="nav-locked"><i class="fa-solid fa-user"></i>
                    Profile</a></li>
            <li class="nav-locked"><a href="search.html" class="nav-locked"><i class="fa-solid fa-search"></i>Cari
                    Akun</a></li>
            <li><a href="nilaiv2.html" class="active"><i class="fa-solid fa-clipboard-check"></i>Nilai PSASI 25-26</a>
            </li>
            <h3>Lessons</h3>
            <li><a href="bahasaindonesia.html"><i class="fa-solid fa-book"></i>B. Indonesia</a></li>
            <li><a href="bahasainggris.html"><i class="fa-solid fa-language"></i>B. Inggris</a></li>
            <li><a href="bahasasunda.html"><B style="margin-right: 10px;">á®˜</B>B. Sunda</a></li>
            <li><a href="bahasajepang.html"><b style="margin-right: 10px;">ã‚¢</b>B. Jepang</a></li>
            <li><a href="matematika.html"><i class="fa-solid fa-calculator"></i>Matematika</a></li>
            <li><a href="proipas.html"><i class="fa-solid fa-atom"></i>Proipas</a></li>
            <li><a href="sejarah.html"><i class="fa-solid fa-landmark"></i>Sejarah</a></li>
            <li><a href="pabp.html"><i class="fa-solid fa-mosque"></i>PABP</a></li>
            <li><a href="pp.html"><i class="fa-solid fa-scale-balanced"></i>PP</a></li>
            <li><a href="senibudaya.html"><i class="fa-solid fa-masks-theater"></i>Seni Budaya</a></li>
            <li><a href="pjok.html"><i class="fa-solid fa-person-running"></i>PJOK</a></li>
            <li><a href="informatika.html"><i class="fa-solid fa-laptop"></i>Informatika</a></li>
            <li><a href="bk.html"><i class="fa-solid fa-heart-circle-check"></i>BK</a></li>
            <li><a href="dpr1.html"><i class="fa-solid fa-laptop-code"></i>DASPROG 1</a></li>
            <li><a href="dpr2.html"><i class="fa-solid fa-microchip"></i>DASPROG 2</a></li>
            <li><a href="dpr3.html"><i class="fa-solid fa-palette"></i>DASPROG 3</a></li>
            </li>
        </ul>
        </ul>
    </div>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <div class="main-content">
        <div class="left-section">
            <h1 style="color: #00eaff;">Nilai PSAS</h1>
            <p style="opacity: 0.8; margin-bottom: 20px;">PSASI 25-26 â€¢ X-RPL 2</p>

            <div class="carddashboard">
                <img id="pp" src="profpicture.png">
                <div class="userInfo">
                    <p id="uname" style="margin:0; font-weight:bold;">@username</p>
                    <h3 id="name" style="margin:0; opacity:0.8;">Loading...</h3>
                </div>
                <div style="clear:both;"></div>

                <div style="margin-top: 20px;">
                    <h3>Daftar Nilai Kamu:</h3>
                    <table class="personal-table" id="personalTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Mapel</th>
                                <th>Nilai</th>
                                <th>KKM?</th>
                            </tr>
                        </thead>
                        <tbody id="personalTableBody">
                        </tbody>
                    </table>
                </div>

                <div style="text-align:center; margin-top:20px;">
                    <h3 style="margin-bottom:5px;">Rata-Rata Kamu:</h3>
                    <h2 id="rataNum">-</h2>
                    <p id="ucapanText" style="margin-top:10px; font-style:italic;"></p>
                    <p id="peringkat" style="margin-top:10px; font-weight:bold; color:#00eaff;"></p>
                </div>
            </div>

            <div class="course-card">
                <h3>Top 10 Leaderboard</h3>
                <h4>Berdasarkan Rata-Rata Tertinggi (Auto-Sync)</h4>

                <div class="podium-container-5" id="podiumTop3">
                </div>
                <hr style="margin: 30px 0; border-color:rgba(255,255,255,0.1);">
                <div class="podium-container-5" id="podiumRest">
                </div>
            </div>
        </div>

        <div class="right-section">
            <h2 style="color: #00eaff;">Daftar Nilai Kelas</h2>
            <p style="opacity:0.7; margin-bottom:15px;">Pilih Mapel untuk melihat nilai semua siswa.</p>

            <select id="mapelSelector" class="mapel-select" onchange="renderClassTable()">
                <option value="pabp">PABP</option>
                <option value="pp">PP</option>
                <option value="bindo">B. Indonesia</option>
                <option value="bing">B. Inggris</option>
                <option value="mtk">Matematika</option>
                <option value="sejarah">Sejarah</option>
                <option value="bjepang">B. Jepang</option>
                <option value="bsunda">B. Sunda</option>
                <option value="senibudaya">Seni Budaya</option>
                <option value="informatika">Informatika</option>
                <option value="pjok">PJOK</option>
                <option value="proipas">Proipas</option>
                <option value="dasprog1">DASPROGRPL 1</option>
                <option value="dasprog2">DASPROGRPL 2</option>
                <option value="dasprog3">DASPROGRPL 3</option>
            </select>

            <div style="overflow-x:auto;">
                <table class="personal-table" style="text-align:left;">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nama</th>
                            <th>Nilai</th>
                        </tr>
                    </thead>
                    <tbody id="classTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Config Mapel (Harus sama persis ID-nya dengan kolom database & admin-nilai)
        const MAPEL_CONFIG = {
            'pabp': 'PABP',
            'pp': 'PP',
            'bindo': 'B. Indonesia',
            'bing': 'B. Inggris',
            'mtk': 'Matematika',
            'sejarah': 'Sejarah',
            'bjepang': 'B. Jepang',
            'bsunda': 'B. Sunda',
            'senibudaya': 'Seni Budaya',
            'informatika': 'Informatika',
            'pjok': 'PJOK',
            'proipas': 'Proipas',
            'dasprog1': 'DASPROGRPL 1',
            'dasprog2': 'DASPROGRPL 2',
            'dasprog3': 'DASPROGRPL 3'
        };

        const KKM = 75;
        let globalData = []; // Penampung data nilai satu kelas

        // 1. AMBIL USER DARI LOCALSTORAGE
        const localUser = JSON.parse(localStorage.getItem("user"));

        // Tentukan identitas (Prioritas Nickname, Fallback ke Username)
        const myIdentifier = localUser ? (localUser.nickname || localUser.username) : null;

        document.addEventListener("DOMContentLoaded", async function () {
            // Cek Login
            if (!localUser || !localUser.class_id) {
                console.warn("User belum login atau Class ID hilang.");
                // alert("Sesi habis, silakan login lagi.");
                window.location.href = "index.html";
                return;
            }

            console.log("Login:", myIdentifier, "| Kelas:", localUser.class_id);

            // Init Sidebar/Pengumuman (kalo ada)
            if (typeof SubjectApp !== 'undefined') SubjectApp.init("announcements", "Pengumuman");

            // Set UI Header
            updateProfileUI(localUser);

            // Tarik Data (Filter Kelas)
            await loadData();
        });

        function updateProfileUI(user) {
            // Update Header & Dashboard Info
            const ids = ['headerName', 'name', 'uname'];
            const display = user.nickname || user.full_name || user.username;

            if (document.getElementById('headerName')) document.getElementById('headerName').innerText = `Hai, ${display}`;
            if (document.getElementById('name')) document.getElementById('name').innerText = user.full_name || display;
            if (document.getElementById('uname')) document.getElementById('uname').innerText = `@${user.username}`;

            // Update Foto
            const ppUrl = user.avatar_url || 'profpicture.png';
            if (document.getElementById('headerPP')) document.getElementById('headerPP').src = ppUrl;
            if (document.getElementById('pp')) document.getElementById('pp').src = ppUrl;
        }

        // FUNGSI UTAMA: LOAD DATA DENGAN FILTER KELAS
        async function loadData() {
            // Query ke Supabase: Ambil SEMUA data nilai, TAPI cuma yang class_id nya sama
            const { data, error } = await supabase
                .from('nilai_psasi')
                .select('*')
                .eq('class_id', localUser.class_id); // <--- FILTER PENTING INI

            if (error) {
                console.error("Gagal tarik data:", error);
                return;
            }

            if (!data || data.length === 0) {
                console.warn("Data nilai kosong untuk kelas ini.");
                document.getElementById('rataNum').innerText = "Belum Ada Data";
                return;
            }

            // 1. Hitung Rata-rata Tiap Siswa
            globalData = data.map(siswa => {
                let total = 0, count = 0;
                for (let key in MAPEL_CONFIG) {
                    let val = parseFloat(siswa[key]);
                    if (!isNaN(val)) {
                        total += val;
                        count++;
                    }
                }
                // Kalau mapel kosong, rata-rata 0
                const avg = count > 0 ? (total / count).toFixed(2) : "0.00";
                return { ...siswa, average: parseFloat(avg) };
            });

            // 2. Urutkan Ranking (Tertinggi ke Terendah)
            globalData.sort((a, b) => b.average - a.average);

            // 3. Render Tampilan
            renderPersonal();
            renderPodium();
            renderClassTable();
        }

        function renderPersonal() {
            if (!myIdentifier) return;

            const myIndex = globalData.findIndex(s =>
                s.nama_siswa.toLowerCase() === myIdentifier.toLowerCase()
            );
            const myData = globalData[myIndex];

            if (!myData) {
                document.getElementById('rataNum').innerText = "-";
                document.getElementById('peringkat').innerText = "Data nilai kamu belum diinput.";
                return;
            }

            // Tampilkan Rata-rata (toFixed(2) udah ada di calculation awal, jadi aman)
            const rataEl = document.getElementById('rataNum');
            rataEl.innerText = myData.average; // Ini string "xx.xx"

            

            const totalSiswa = globalData.length;
            const rank = myIndex + 1;
            const kalahkan = totalSiswa - rank;
            document.getElementById('peringkat').innerHTML = `
            Peringkat <span style="font-size:1.2em; color:#ffd700;">#${rank}</span> 
            dari ${totalSiswa} siswa`;

            // --- LOGIC WARNA & UCAPAN BARU (6 TIER) ---       
        const ucapan = document.getElementById('ucapanText');

        // Reset style dasar
        rataEl.style.color = "#fff"; 
        rataEl.style.boxShadow = "none";
        rataEl.style.textShadow = "none";

        if (myData.average >= 80) {
            // TIER DEWA: Biru Cyan (Dingin / Icy)
            rataEl.style.background = "#00eaff"; 
            rataEl.style.boxShadow = "0 0 20px rgba(0, 234, 255, 0.8)";
            ucapan.innerText = "dinginn ah di puncakðŸ¥¶";
        } 
        else if (myData.average >= 75) {
            // TIER AMAN: Hijau Segar
            rataEl.style.background = "#2ecc71"; 
            ucapan.innerText = "pass KKM eyyy, hore";
        } 
        else if (myData.average >= 70) {
            // TIER NYARIS: Kuning Emas
            rataEl.style.background = "#f1c40f"; 
            ucapan.innerText = "yah tipis";
        } 
        else if (myData.average >= 60) {
            // TIER LUMAYAN: Orange
            rataEl.style.background = "#e67e22"; 
            ucapan.innerText = "lumayann lahh sakie ma";
        } 
        else if (myData.average >= 50) {
            // TIER BAWAH: Merah Terang
            rataEl.style.background = "#e74c3c"; 
            ucapan.innerText = "gaoaoa, trs semangat";
        } 
        else {
            // TIER JUJUR: Merah Gelap (Maroon)
            rataEl.style.background = "#c0392b"; 
            ucapan.innerText = "gapapa dibawah 50, yang penting jujur.";
        }

            // Render Tabel Personal
            const tbody = document.getElementById('personalTableBody');
            tbody.innerHTML = "";
            let no = 1;

            for (let key in MAPEL_CONFIG) {
                const val = parseFloat(myData[key]);
                const isAda = !isNaN(val);

                // UPDATE DISINI: Pake toFixed(2) biar muncul .00
                const displayVal = isAda ? val.toFixed(2) : "-";

                let statusIcon = "-";
                if (isAda) {
                    statusIcon = val >= KKM
                        ? `<i class="fa-solid fa-check" style="color:#2ecc71;"></i>`
                        : `<i class="fa-solid fa-xmark" style="color:#e74c3c;"></i>`;
                }

                const tr = `<tr>
                <td>${no++}</td>
                <td style="text-align:left;">${MAPEL_CONFIG[key]}</td>
                <td>${displayVal}</td>
                <td>${statusIcon}</td>
            </tr>`;
                tbody.innerHTML += tr;
            }
        }

        function renderPodium() {
            const top3 = document.getElementById('podiumTop3');
            const rest = document.getElementById('podiumRest');
            if (top3) top3.innerHTML = "";
            if (rest) rest.innerHTML = "";

            // Fungsi Bikin Kotak Podium
            const createPodiumHTML = (siswa, rank, cls) => `
            <div class="podium ${cls}">
                <img src="studentsprofile/${siswa.nama_siswa}.jpg" class="pp-top" onerror="this.src='profpicture.png'">
                <div style="font-weight:bold; margin-top:5px; font-size:13px;">${siswa.nama_siswa}</div>
                <div style="font-size:12px; margin-top:2px;">${siswa.average}</div>
                <div style="font-size:20px; font-weight:900; opacity:0.3; position:absolute; bottom:5px; left:50%; transform:translateX(-50%);">${rank}</div>
            </div>
        `;

            // Render Juara 1, 2, 3 (Urutan visual: 2 - 1 - 3)
            if (globalData[1]) top3.innerHTML += createPodiumHTML(globalData[1], 2, 'p2');
            if (globalData[0]) top3.innerHTML += createPodiumHTML(globalData[0], 1, 'p1');
            if (globalData[2]) top3.innerHTML += createPodiumHTML(globalData[2], 3, 'p3');

            // Render Rank 4-10
            for (let i = 3; i < 10; i++) {
                if (globalData[i]) {
                    rest.innerHTML += createPodiumHTML(globalData[i], i + 1, 'pd');
                }
            }
        }

        function renderClassTable() {
            const mapelKey = document.getElementById('mapelSelector').value;
            const tbody = document.getElementById('classTableBody');
            tbody.innerHTML = '';

            const sortedList = [...globalData].sort((a, b) => {
                const valA = parseFloat(a[mapelKey]) || 0;
                const valB = parseFloat(b[mapelKey]) || 0;
                return valB - valA;
            });

            sortedList.forEach((siswa, i) => {
                const val = parseFloat(siswa[mapelKey]);
                // UPDATE DISINI: Pake toFixed(2)
                const displayVal = !isNaN(val) ? val.toFixed(2) : "-";

                const tr = document.createElement('tr');

                if (myIdentifier && siswa.nama_siswa.toLowerCase() === myIdentifier.toLowerCase()) {
                    tr.style.background = 'rgba(0, 234, 255, 0.15)';
                    tr.style.fontWeight = 'bold';
                    tr.style.borderLeft = '3px solid #00eaff';
                }

                tr.innerHTML = `
                <td>${i + 1}</td>
                <td>${siswa.nama_siswa}</td>
                <td>${displayVal}</td>
            `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>

</html>